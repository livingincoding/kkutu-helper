<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>1129code Multi Encrypt/Decrypt (Drag & Drop)</title>
<style>
:root{--bg:#f7fafc;--card:#fff;--muted:#6b7280;--accent:#111827;--ok:#10b981;--err:#ef4444}
body{font-family:system-ui;background:var(--bg);color:#0f172a;margin:18px}
.container{max-width:920px;margin:0 auto}
.card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,.06)}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between}
.controls{display:flex;gap:8px;flex-wrap:wrap;min-width:320px}
select,input[type="password"]{padding:8px;border-radius:8px;border:1px solid #e6eaf0}
button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
button:disabled{opacity:.5;cursor:default}
.drop{margin-top:14px;border:2px dashed #e6eaf0;border-radius:10px;padding:18px;text-align:center;color:var(--muted);transition:.18s;background:transparent}
.drop.dragover{background:#f1f5f9;border-color:#c7d2fe;color:#0f172a}
.meta{display:flex;gap:8px;align-items:center}
.file-list{margin-top:12px}
.file-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid #f1f5f9;margin-bottom:8px}
.file-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f5f9;color:var(--muted)}
.status{font-size:13px;color:var(--muted);min-width:120px;text-align:right}
.progress{height:8px;background:#eef2ff;border-radius:999px;overflow:hidden;margin-top:6px}
.progress > i{display:block;height:100%;width:0;background:#4f46e5;transition:width .35s}
.controls-row{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
.small{font-size:13px;color:var(--muted)}
.checkbox{margin-right:8px}
.actions{display:flex;gap:8px}
.footer{margin-top:10px;color:var(--muted);font-size:13px}
.icon{width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;border-radius:6px;background:#f8fafc}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">
      <div>
        <h3 style="margin:0">1129code — 멀티 파일 암/복호화</h3>
        <div class="small">드래그 & 드롭 또는 파일선택 → 파일 체크 → 실행</div>
      </div>
      <div class="meta">
        <div class="badge">클라이언트 전용</div>
      </div>
    </div>

    <div class="controls" style="margin-top:12px">
      <select id="mode">
        <option value="enc">암호화 (Encrypt)</option>
        <option value="dec">복호화 (Decrypt)</option>
      </select>
      <input id="pw" type="password" placeholder="비밀번호" style="min-width:220px">
      <input id="fileInput" type="file" multiple style="display:none">
      <button id="choose">파일 선택</button>
      <div class="small">PBKDF2 300k · AES-GCM-256 · 확장자 보존</div>
    </div>

    <div id="drop" class="drop">파일을 여기로 드래그하거나 '파일 선택'을 누르세요.</div>

    <div class="controls-row">
      <label><input id="selectAll" type="checkbox" class="checkbox"> 전체선택</label>
      <div class="actions">
        <button id="start">실행</button>
        <button id="clear">리스트 초기화</button>
      </div>
      <div style="margin-left:auto" class="small" id="summary">파일: 0</div>
    </div>

    <div id="list" class="file-list"></div>

    <div class="footer">원본 확장자 저장: 암호화 파일 내부에 안전히 포함. 복호화 시 정확 복원.</div>
  </div>
</div>

<script>
/* Tink Step-by-Step:
   1) 상수 / 유틸
   2) 파일 관리 UI
   3) 암/복호화 함수(확장자 저장/복원)
   4) 배치 처리 및 상태 업데이트
*/

const MAGIC = new TextEncoder().encode('1129CODE'); // 8 bytes
const SALT = 16, IV = 12, ITER = 300000;
const encT = new TextEncoder(), decT = new TextDecoder();

const chooseBtn = document.getElementById('choose');
const fileInput = document.getElementById('fileInput');
const drop = document.getElementById('drop');
const listEl = document.getElementById('list');
const startBtn = document.getElementById('start');
const clearBtn = document.getElementById('clear');
const modeSel = document.getElementById('mode');
const pwInput = document.getElementById('pw');
const selectAll = document.getElementById('selectAll');
const summary = document.getElementById('summary');

let files = []; // {file, id, checked, status, progress, node}

function uiUpdateSummary(){ summary.textContent = `파일: ${files.length}`; }

function makeId(){ return Math.random().toString(36).slice(2,9); }

function addFilesList(fileList){
  for(const f of fileList){
    const id = makeId();
    const node = document.createElement('div');
    node.className = 'file-item';
    node.innerHTML = `
      <input type="checkbox" data-id="${id}" class="checkbox" checked>
      <div style="width:36px;text-align:center" title="${f.type || ''}">${Math.round(f.size/1024)}KB</div>
      <div class="file-name">${f.name}</div>
      <div style="width:160px">
        <div class="progress"><i></i></div>
        <div class="small status" data-id="${id}">대기</div>
      </div>
      <div style="width:80px;text-align:right">
        <button data-action="remove" data-id="${id}">삭제</button>
      </div>
    `;
    listEl.appendChild(node);

    files.push({file:f,id,checked:true,status:'대기',progress:0,node});
    // checkbox listener
    node.querySelector('input[type="checkbox"]').addEventListener('change', (e)=>{
      const it = files.find(x=>x.id===id); if(it) it.checked = e.target.checked;
      updateSelectAllState();
    });
    node.querySelector('button[data-action="remove"]').addEventListener('click', ()=>{
      removeFileById(id);
    });
  }
  uiUpdateSummary();
  updateSelectAllState();
}

function removeFileById(id){
  const idx = files.findIndex(x=>x.id===id);
  if(idx>=0){
    const n = files[idx].node;
    n.remove();
    files.splice(idx,1);
    uiUpdateSummary();
    updateSelectAllState();
  }
}

function updateSelectAllState(){
  if(files.length===0){ selectAll.checked=false; return;}
  const all = files.every(f=>f.checked);
  selectAll.checked = all;
}

/* --------------------------
   Drag & Drop
---------------------------*/
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault();drop.classList.add('dragover');}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault();drop.classList.remove('dragover');}));
drop.addEventListener('drop', e=>{
  const dt = e.dataTransfer;
  if(dt && dt.files && dt.files.length) addFilesList(dt.files);
});

/* file input / choose */
chooseBtn.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', e=>{
  if(e.target.files && e.target.files.length) addFilesList(e.target.files);
});

/* select all toggle */
selectAll.addEventListener('change',(e)=>{
  files.forEach(f=>{
    f.checked = e.target.checked;
    const cb = listEl.querySelector(`input[type="checkbox"][data-id="${f.id}"]`);
    if(cb) cb.checked = e.target.checked;
  });
});

/* clear */
clearBtn.addEventListener('click', ()=>{ files=[]; listEl.innerHTML=''; uiUpdateSummary(); });

/* --------------------------
   Crypto helpers
---------------------------*/
async function deriveKey(pw, salt){
  const base = await crypto.subtle.importKey('raw', encT.encode(pw), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:ITER, hash:'SHA-256'}, base, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
}

function cat(arr){
  let tot = arr.reduce((s,a)=>s + a.length, 0);
  let out = new Uint8Array(tot); let off=0;
  for(const a of arr){ out.set(a, off); off += a.length; }
  return out;
}

function downloadBlob(blob, name){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=name;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},800);
}

/* 확장자 추출 */
function getExt(name){ const i=name.lastIndexOf('.'); return i>-1?name.slice(i+1):''; }

/* --------------------------
   Encrypt / Decrypt (single file)
   Format enc: [MAGIC][SALT][IV][EXT_LEN][EXT][CIPHER]
---------------------------*/
async function encryptSingle(file, pw, onProgress){
  const plain = await file.arrayBuffer();
  const salt = crypto.getRandomValues(new Uint8Array(SALT));
  const iv   = crypto.getRandomValues(new Uint8Array(IV));
  const key  = await deriveKey(pw, salt);

  const extStr = getExt(file.name);
  const extBytes = encT.encode(extStr);
  const extLen = new Uint8Array([extBytes.length]);

  // 암호화 (전체 블롭이기 때문에 진행 콜백은 흉내)
  if(onProgress) onProgress(20);
  const cipher = new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, plain));
  if(onProgress) onProgress(90);

  const out = cat([MAGIC, salt, iv, extLen, extBytes, cipher]);
  downloadBlob(new Blob([out]), file.name + '.1129code');
  if(onProgress) onProgress(100);
  return '암호화 완료';
}

async function decryptSingle(file, pw, onProgress){
  const buf = new Uint8Array(await file.arrayBuffer());
  // magic check
  for(let i=0;i<MAGIC.length;i++) if(buf[i]!==MAGIC[i]) throw '포맷 불일치';
  let p = MAGIC.length;
  const salt = buf.slice(p, p+=SALT);
  const iv   = buf.slice(p, p+=IV);
  const extLen = buf[p++];
  const ext = buf.slice(p, p+=extLen);
  const cipher = buf.slice(p);
  const key = await deriveKey(pw, salt);
  if(onProgress) onProgress(30);
  let plain;
  try{
    plain = new Uint8Array(await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, cipher));
  }catch{
    throw '비밀번호 틀림 또는 손상';
  }
  if(onProgress) onProgress(80);
  const extStr = decT.decode(ext);
  const base = file.name.endsWith('.1129code') ? file.name.slice(0,-8) : file.name;
  const baseClean = base.includes('.') ? base.slice(0, base.lastIndexOf('.')) : base;
  downloadBlob(new Blob([plain]), baseClean + (extStr?'.'+extStr:''));
  if(onProgress) onProgress(100);
  return '복호화 완료';
}

/* --------------------------
   Batch runner
---------------------------*/
async function runBatch(){
  const pw = pwInput.value;
  if(!pw){ alert('비밀번호 입력'); return; }
  const selected = files.filter(f=>f.checked);
  if(selected.length===0){ alert('처리할 파일 선택'); return; }

  startBtn.disabled = true; clearBtn.disabled = true;
  for(const item of selected){
    const statusEl = item.node.querySelector('.status');
    const progressBar = item.node.querySelector('.progress > i');
    const setStatus = (s, color)=>{ statusEl.textContent = s; statusEl.style.color = color || ''; };
    const setProgress = (v)=>{ progressBar.style.width = (v>100?100:v)+'%'; };

    // start
    item.status='진행중'; setStatus('진행중...', '#0f172a'); setProgress(5);
    try{
      if(modeSel.value === 'enc'){
        await encryptSingle(item.file, pw, (p)=>{ setProgress(p); });
        item.status='완료'; setStatus('완료', 'var(--ok)'); setProgress(100);
      }else{
        await decryptSingle(item.file, pw, (p)=>{ setProgress(p); });
        item.status='완료'; setStatus('완료', 'var(--ok)'); setProgress(100);
      }
    }catch(err){
      item.status='오류'; setStatus(String(err), 'var(--err)'); setProgress(0);
    }
    await new Promise(r=>setTimeout(r,200)); // UI 여유
  }

  startBtn.disabled = false; clearBtn.disabled = false;
}

/* start */
startBtn.addEventListener('click', runBatch);

/* remove on Enter? not needed */

/* drag hint click to choose */
drop.addEventListener('click', ()=>fileInput.click());

</script>
</body>
</html>
